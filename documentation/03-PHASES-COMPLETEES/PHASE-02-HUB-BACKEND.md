# üöÄ Phase 2 : D√©veloppement du Hub Central

## üéØ Objectif Principal

Cr√©er le **HUB CENTRAL** qui permet aux donateurs d'avoir une vision unifi√©e cross-tenant de toutes leurs contributions, tout en conservant l'isolation s√©curis√©e des donn√©es par tenant.

## üìã Vision Fonctionnelle

### üåê Pour les Donateurs
- **Compte unique** : Un seul login pour acc√©der √† toutes les associations
- **Vision consolid√©e** : Voir tous ses dons peu importe l'association ou la source
- **Historique unifi√©** : Timeline compl√®te de tous les dons avec filtres
- **Re√ßus centralis√©s** : Tous les CERFA accessibles depuis un seul endroit
- **D√©couverte** : Annuaire complet des associations avec recherche et filtres

### üèõÔ∏è Pour les Associations
- **Analytics multi-sources** : Dons re√ßus via plateforme centrale ET site personnalis√©
- **Distinction claire** : Chaque don marqu√© avec sa source (PLATFORM/CUSTOM_SITE)
- **Export unifi√©** : Comptabilit√© consolid√©e toutes sources confondues
- **Performance** : Comparaison plateforme vs site custom

## üèóÔ∏è Architecture Technique

### üìä Nouvelles Tables Cross-Tenant

```prisma
// Profil donateur global (cross-tenant)
model DonorProfile {
  id              String   @id @default(cuid())
  cognitoUserId   String   @unique  // Lien avec AWS Cognito
  email           String   @unique
  firstName       String
  lastName        String
  phone           String?
  address         Json?    // Adresse compl√®te pour CERFA
  preferences     Json?    // Pr√©f√©rences de notification, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations cross-tenant
  donations       Donation[]
  favoriteAssocs  AssociationListing[]
  
  @@map("donor_profiles")
}

// Listing global des associations (toutes confondues)
model AssociationListing {
  id                String   @id @default(cuid())
  tenantId          String   // R√©f√©rence au tenant
  name              String
  description       String?
  category          String   // synagogue, tzedaka, education, etc.
  city              String?
  region            String?
  logo              String?
  website           String?
  hasCustomSite     Boolean  @default(false)
  customDomain      String?
  isActive          Boolean  @default(true)
  featured          Boolean  @default(false)
  totalDonations    Decimal  @default(0) @db.Decimal(10,2)
  donorCount        Int      @default(0)
  lastDonationAt    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  donations         Donation[]
  favoredBy         DonorProfile[]
  
  @@map("association_listings")
  @@index([category])
  @@index([city])
  @@index([featured])
}
```

### üîÑ Extension Table Donations

```prisma
model Donation {
  // Champs existants...
  id          String        @id @default(cuid())
  tenantId    String
  amount      Decimal       @db.Decimal(10,2)
  currency    String        @default("EUR")
  status      DonationStatus
  
  // NOUVEAUX CHAMPS HUB CENTRAL
  source         DonationSource  @default(PLATFORM)  // PLATFORM ou CUSTOM_SITE
  donorProfileId String?         // Lien vers profil global donateur
  associationId  String?         // Lien vers listing association
  
  // Relations √©tendues
  donorProfile   DonorProfile?     @relation(fields: [donorProfileId], references: [id])
  association    AssociationListing? @relation(fields: [associationId], references: [id])
  
  @@map("donations")
}

enum DonationSource {
  PLATFORM     // Don fait via la plateforme centrale
  CUSTOM_SITE  // Don fait via le site personnalis√© de l'association
}
```

## üìÖ Planning D√©taill√© - 4 Semaines

### üõ†Ô∏è Semaine 1 : Infrastructure Cross-Tenant

**Objectifs** :
- Impl√©menter les nouvelles tables cross-tenant
- Cr√©er les services d'agr√©gation des donn√©es
- D√©velopper les API endpoints cross-tenant s√©curis√©s

**Livrables** :
- [ ] **Migration Prisma** : Nouvelles tables `DonorProfile` et `AssociationListing`
- [ ] **Extension table Donations** : Champs `source`, `donorProfileId`, `associationId`
- [ ] **DonorService** : Service de gestion des profils donateurs cross-tenant
- [ ] **AssociationListingService** : Service annuaire global des associations
- [ ] **API Endpoints** : `/api/donor/profile`, `/api/associations/directory`
- [ ] **Tests unitaires** : Validation des nouveaux services
- [ ] **Seed donn√©es** : Profils donateurs et associations test

**Architecture** :
```typescript
// Services principaux
src/
‚îú‚îÄ‚îÄ donor-portal/
‚îÇ   ‚îú‚îÄ‚îÄ donor-portal.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ donor.service.ts           // Gestion profils donateurs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ donation-aggregator.service.ts  // Agr√©gation cross-tenant
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ association-listing.service.ts  // Annuaire global
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ donor.controller.ts        // API profil donateur
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ directory.controller.ts    // API annuaire associations
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îú‚îÄ‚îÄ donor-profile.dto.ts
‚îÇ       ‚îî‚îÄ‚îÄ association-search.dto.ts
```

### üé® Semaine 2 : Portail Donateur Frontend

**Objectifs** :
- Cr√©er l'interface du portail donateur unifi√©
- Impl√©menter la recherche et d√©couverte d'associations
- D√©velopper le dashboard des dons cross-tenant

**Livrables** :
- [ ] **Page connexion unifi√©e** : Login unique pour acc√®s cross-tenant
- [ ] **Dashboard donateur** : Vue d'ensemble de tous les dons
- [ ] **Historique consolid√©** : Timeline avec filtres par association/date/montant
- [ ] **Annuaire associations** : Recherche, filtres, cartes interactives
- [ ] **Gestion profil** : Modification donn√©es personnelles et pr√©f√©rences
- [ ] **Responsive design** : Interface mobile-first avec Shadcn/UI

**Structure Frontend** :
```typescript
frontend-hub/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (donor-portal)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              // Dashboard principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DonationSummary.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RecentDonations.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FavoriteAssociations.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              // Historique complet
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DonationFilter.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ DonationTimeline.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ directory/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              // Annuaire associations
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AssociationCard.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SearchFilters.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ MapView.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx              // Gestion profil
```

### üìä Semaine 3 : Analytics Multi-Sources

**Objectifs** :
- D√©velopper le dashboard admin avec vision multi-sources
- Impl√©menter les m√©triques de performance par source
- Cr√©er les exports comptables unifi√©s

**Livrables** :
- [ ] **Dashboard admin √©tendu** : Vue des dons par source (plateforme vs custom)
- [ ] **Analytics comparatifs** : Graphiques performance PLATFORM vs CUSTOM_SITE
- [ ] **M√©triques avanc√©es** : Conversion, r√©currence, panier moyen par source
- [ ] **Export unifi√©** : Comptabilit√© consolid√©e toutes sources
- [ ] **Rapport mensuel** : PDF automatique avec analytics multi-sources
- [ ] **API reporting** : Endpoints d√©di√©s aux statistics cross-tenant

**Extension Admin Service** :
```typescript
// Extension du AdminService existant
export class AdminService {
  // M√©thodes existantes...
  
  // NOUVELLES M√âTHODES MULTI-SOURCES
  async getMultiSourceStats(tenantId: string) {
    // Stats comparatives PLATFORM vs CUSTOM_SITE
    const platformDonations = await this.getDonationsBySource(tenantId, 'PLATFORM');
    const customSiteDonations = await this.getDonationsBySource(tenantId, 'CUSTOM_SITE');
    
    return {
      platform: {
        total: platformDonations.total,
        count: platformDonations.count,
        average: platformDonations.average,
        growth: platformDonations.growth
      },
      customSite: {
        total: customSiteDonations.total,
        count: customSiteDonations.count,
        average: customSiteDonations.average,
        growth: customSiteDonations.growth
      },
      comparison: {
        totalRatio: platformDonations.total / customSiteDonations.total,
        countRatio: platformDonations.count / customSiteDonations.count,
        conversionRate: this.calculateConversionRates(tenantId)
      }
    };
  }
  
  async generateUnifiedExport(tenantId: string, startDate: Date, endDate: Date) {
    // Export comptable unifi√© toutes sources
  }
}
```

### üîß Semaine 4 : Int√©gration et Tests E2E

**Objectifs** :
- Int√©grer tous les composants du Hub Central
- Valider les flux end-to-end cross-tenant
- Optimiser les performances des requ√™tes cross-tenant

**Livrables** :
- [ ] **Tests E2E Hub Central** : Sc√©narios complets donateur cross-tenant
- [ ] **Tests isolation s√©curis√©e** : Validation que les donn√©es restent cloisonn√©es
- [ ] **Tests performance** : Requ√™tes cross-tenant optimis√©es
- [ ] **Cache Redis √©tendu** : Strat√©gies de cache pour donn√©es globales
- [ ] **Documentation API** : Swagger complet pour nouveaux endpoints
- [ ] **Guide d√©ploiement** : Proc√©dures de mise en production

**Tests E2E Critiques** :
```typescript
// test/hub-central.e2e-spec.ts
describe('Hub Central E2E', () => {
  it('should allow donor to see all donations across tenants', async () => {
    // 1. Cr√©er donateur avec dons sur 2 tenants diff√©rents
    // 2. Login unique
    // 3. V√©rifier vision consolid√©e
    // 4. V√©rifier isolation s√©curis√©e (ne voit que SES dons)
  });
  
  it('should show association multi-source analytics', async () => {
    // 1. Cr√©er dons via PLATFORM et CUSTOM_SITE
    // 2. Admin login
    // 3. V√©rifier analytics s√©par√©es par source
    // 4. V√©rifier totaux consolid√©s
  });
  
  it('should maintain data isolation while allowing cross-tenant views', async () => {
    // Test critique : cross-tenant autoris√© UNIQUEMENT pour ses propres donn√©es
  });
});
```

## üîê S√©curit√© Cross-Tenant

### üõ°Ô∏è Principes de S√©curit√©

1. **Isolation maintenue** : Les tenants restent compl√®tement isol√©s
2. **Acc√®s contr√¥l√©** : Un donateur ne voit QUE ses propres donn√©es cross-tenant
3. **Validation stricte** : Chaque requ√™te cross-tenant valid√©e par JWT + tenant context
4. **Audit trail** : Logging de tous les acc√®s cross-tenant

### üîë M√©canisme d'Autorisation

```typescript
// Nouveau Guard pour acc√®s cross-tenant
@Injectable()
export class CrossTenantGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const user = request.user;  // Depuis JWT
    
    // V√©rifier que l'utilisateur acc√®de uniquement √† SES donn√©es
    if (request.params.donorProfileId !== user.donorProfileId) {
      throw new ForbiddenException('Cross-tenant access denied');
    }
    
    return true;
  }
}

// Usage sur les routes cross-tenant
@Controller('api/donor')
@UseGuards(JwtAuthGuard, CrossTenantGuard)
export class DonorController {
  @Get('profile/:donorProfileId/donations')
  async getDonorDonationsAcrossAllTenants(@Param('donorProfileId') donorProfileId: string) {
    // API s√©curis√©e : un donateur ne voit que SES dons cross-tenant
  }
}
```

## üìà M√©triques de Succ√®s

### üéØ KPIs Phase 2

- **Performance** : API cross-tenant < 200ms
- **S√©curit√©** : 0 acc√®s non autoris√© cross-tenant
- **Adoption** : Dashboard donateur utilis√© par > 80% des utilisateurs connect√©s
- **Analytics** : Admins acc√®dent aux stats multi-sources quotidiennement
- **Tests** : Couverture > 90% sur nouveaux composants

### üìä M√©triques Fonctionnelles

- **Vision donateur** : Affichage correct de 100% des dons cross-tenant
- **D√©couverte associations** : Recherche < 500ms sur 10000+ associations
- **Export comptable** : G√©n√©ration PDF < 30s pour 1 an de donn√©es
- **Cache efficacit√©** : Hit rate > 85% sur donn√©es global

## üîÑ Migration des Donn√©es Existantes

### üìã Plan de Migration

1. **Phase pr√©paratoire** :
   - Backup complet de la base de donn√©es
   - Tests migration sur environnement de staging

2. **Migration donn√©es** :
   - Cr√©ation `DonorProfile` pour tous les utilisateurs existants
   - Population `AssociationListing` depuis les tenants
   - Mise √† jour `Donation` avec nouveaux champs

3. **Validation post-migration** :
   - Tests e2e complets
   - V√©rification int√©grit√© des donn√©es
   - Performance benchmark

## üöÄ Prochaines √âtapes

Une fois la Phase 2 termin√©e, nous aurons :

‚úÖ **Hub Central fonctionnel** avec vision donateur unifi√©e
‚úÖ **Analytics multi-sources** pour les associations  
‚úÖ **Infrastructure pr√™te** pour sites personnalis√©s (Phase 3)
‚úÖ **Base solide** pour modules m√©tier avanc√©s (Phase 4)

La Phase 2 pose les fondations du v√©ritable √©cosyst√®me multi-tenant avec le Hub Central comme pivot de l'exp√©rience utilisateur.
