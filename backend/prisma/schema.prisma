// Schéma Prisma Multi-Tenant avec Row Level Security

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Table principale des tenants
model Tenant {
  id          String   @id @default(uuid())
  slug        String   @unique // utilisé pour identification (subdomain)
  name        String
  domain      String?  @unique // domaine personnalisé optionnel
  status      TenantStatus @default(ACTIVE)
  
  // Configuration
  theme       Json     @default("{}")  // Configuration thème personnalisé
  settings    Json     @default("{}")  // Paramètres spécifiques
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  donations   Donation[]
  campaigns   Campaign[]
  gmahs       Gmah[]
  events      Event[]
  associationListing AssociationListing?
  
  @@map("tenants")
}

// Énumération statut tenant
enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

// Table des utilisateurs avec isolation par tenant
model User {
  id          String   @id @default(uuid())
  tenantId    String   // Clé d'isolation
  
  // Identifiants
  email       String
  cognitoId   String   @unique // ID utilisateur AWS Cognito
  
  // Informations personnelles
  firstName   String
  lastName    String
  phone       String?
  
  // Rôles et permissions
  role        UserRole @default(MEMBER)
  permissions Json     @default("[]")
  
  // Statut
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  donations   Donation[]
  campaigns   Campaign[]
  gmahs       Gmah[]
  
  @@unique([tenantId, email]) // Unique email par tenant
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN  // Accès plateforme complète
  ADMIN        // Administrateur tenant
  TREASURER    // Trésorier
  MANAGER      // Gestionnaire
  MEMBER       // Membre standard
}

// Table des dons avec isolation par tenant et source tracking
model Donation {
  id          String   @id @default(uuid())
  tenantId    String   // Clé d'isolation
  userId      String
  
  // Tracking de la source du don
  source      DonationSource @default(PLATFORM) // D'où vient le don
  sourceUrl   String?        // URL spécifique si don depuis site custom
  
  // Informations du don
  amount      Decimal  @db.Decimal(10,2)
  currency    String   @default("EUR")
  type        DonationType
  status      DonationStatus @default(PENDING)
  
  // Paiement
  stripePaymentIntentId String?
  paymentMethod         String?
  
  // Récurrence (pour dons récurrents)
  isRecurring Boolean  @default(false)
  frequency   RecurrenceFrequency?
  nextPaymentDate DateTime?
  
  // Informations fiscales
  isAnonymous Boolean  @default(false)
  fiscalReceiptRequested Boolean @default(true)
  fiscalReceiptNumber String?
  
  // Affectation
  campaignId  String?
  purpose     String? // Destination du don
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
  campaign    Campaign? @relation(fields: [campaignId], references: [id])
  
  @@index([userId]) // Index pour requêtes cross-tenant par user
  @@index([tenantId, source]) // Index pour filtrer par source
  @@map("donations")
}

enum DonationType {
  PUNCTUAL    // Don ponctuel
  RECURRING   // Don récurrent
  SPECIAL     // Don spécial (événement)
}

enum DonationStatus {
  PENDING     // En attente
  COMPLETED   // Complété
  FAILED      // Échoué
  REFUNDED    // Remboursé
  CANCELLED   // Annulé
}

enum RecurrenceFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DonationSource {
  PLATFORM      // Don via la plateforme centrale
  CUSTOM_SITE   // Don via site personnalisé de l'association
  API           // Don via API externe
  IMPORT        // Don importé (historique)
}

// Table des campagnes de collecte
model Campaign {
  id          String   @id @default(uuid())
  tenantId    String   // Clé d'isolation
  userId      String   // Créé par un utilisateur
  
  // Informations de la campagne
  title       String
  description String
  goal        Decimal  @db.Decimal(10,2)
  currency    String   @default("EUR")
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  
  // Statut
  status      CampaignStatus @default(DRAFT)
  isActive    Boolean  @default(true)
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
  donations   Donation[]
  
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT       // Brouillon
  ACTIVE      // Active
  COMPLETED   // Terminée
  CANCELLED   // Annulée
}

// Table Gmah (prêts sans intérêt)
model Gmah {
  id          String   @id @default(uuid())
  tenantId    String   // Clé d'isolation
  borrowerId  String
  
  // Informations du prêt
  amount      Decimal  @db.Decimal(10,2)
  currency    String   @default("EUR")
  purpose     String
  
  // Dates
  requestedAt DateTime @default(now())
  approvedAt  DateTime?
  disbursedAt DateTime?
  
  // Statut
  status      GmahStatus @default(REQUESTED)
  
  // Remboursement
  monthlyPayment Decimal? @db.Decimal(10,2)
  totalPaid   Decimal   @default(0) @db.Decimal(10,2)
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  borrower    User     @relation(fields: [borrowerId], references: [id])
  
  @@map("gmahs")
}

enum GmahStatus {
  REQUESTED   // Demandé
  APPROVED    // Approuvé
  DISBURSED   // Déboursé
  ACTIVE      // Actif (en cours de remboursement)
  COMPLETED   // Remboursé
  DEFAULTED   // En défaut
}

// Table des événements communautaires
model Event {
  id          String   @id @default(uuid())
  tenantId    String   // Clé d'isolation
  
  // Informations de l'événement
  title       String
  description String?
  type        EventType
  
  // Dates et lieu
  startDate   DateTime
  endDate     DateTime?
  location    String?
  
  // Participation
  maxParticipants Int?
  price       Decimal? @db.Decimal(10,2)
  currency    String   @default("EUR")
  
  // Statut
  status      EventStatus @default(DRAFT)
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("events")
}

enum EventType {
  RELIGIOUS   // Événement religieux
  CULTURAL    // Événement culturel
  EDUCATIONAL // Événement éducatif
  SOCIAL      // Événement social
  FUNDRAISING // Collecte de fonds
}

enum EventStatus {
  DRAFT       // Brouillon
  PUBLISHED   // Publié
  CANCELLED   // Annulé
  COMPLETED   // Terminé
}

// Table des profils donateurs globaux (cross-tenant)
model DonorProfile {
  id          String   @id @default(uuid())
  email       String   @unique // Email unique cross-tenant
  cognitoId   String   @unique // ID Cognito unique
  
  // Informations consolidées
  firstName   String
  lastName    String
  phone       String?
  
  // Statistiques globales
  totalDonations     Int      @default(0)
  totalAmount        Decimal  @default(0) @db.Decimal(12,2)
  favoriteAssociations Json   @default("[]") // Liste des tenant IDs favoris
  
  // Préférences
  preferredCurrency  String   @default("EUR")
  communicationPrefs Json     @default("{}")
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastDonationAt DateTime?
  
  // Relations
  tenantAccess TenantDonorAccess[]
  
  @@map("donor_profiles")
}

// Table de liaison donateur-tenant pour tracking cross-tenant
model TenantDonorAccess {
  id            String   @id @default(uuid())
  donorProfileId String
  tenantId      String
  
  // Statistiques par tenant
  totalDonations Int     @default(0)
  totalAmount    Decimal @default(0) @db.Decimal(10,2)
  lastDonationAt DateTime?
  
  // Statut
  isActive      Boolean  @default(true)
  isFavorite    Boolean  @default(false)
  
  // Métadonnées
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  donorProfile  DonorProfile @relation(fields: [donorProfileId], references: [id])
  
  @@unique([donorProfileId, tenantId])
  @@map("tenant_donor_access")
}

// Table des associations (vue publique sur la plateforme)
model AssociationListing {
  id          String   @id @default(uuid())
  tenantId    String   @unique
  
  // Informations publiques
  name        String
  description String   @db.Text
  logo        String?
  coverImage  String?
  category    String
  location    String
  
  // Visibilité
  isPublic    Boolean  @default(true) // Visible sur la plateforme centrale
  isVerified  Boolean  @default(false) // Vérifié par la plateforme
  hasSite     Boolean  @default(false) // A un site personnalisé
  siteUrl     String?  // URL du site personnalisé
  
  // Statistiques publiques
  totalCampaigns Int    @default(0)
  activeCampaigns Int   @default(0)
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("association_listings")
}
